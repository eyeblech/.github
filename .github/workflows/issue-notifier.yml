name: ğŸ”” GitHub Issues Notifier
on:
  issues:
    types: [opened, closed, reopened, edited, labeled, unlabeled, assigned, unassigned]

jobs:
  rich-discord-notification:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ¨ Prepare Rich Data
        id: prepare
        run: |
          # Get action details
          ACTION="${{ github.event.action }}"
          
          # Set action emoji and title
          case "$ACTION" in
            "opened") 
              EMOJI="ğŸ“‚"
              TITLE="NEW ISSUE CREATED"
              COLOR="65280" # Green
              ;;
            "closed")
              EMOJI="âœ…"
              TITLE="ISSUE CLOSED"
              COLOR="15158332" # Red
              ;;
            "reopened")
              EMOJI="ğŸ”„"
              TITLE="ISSUE REOPENED"
              COLOR="16776960" # Yellow
              ;;
            "edited")
              EMOJI="âœï¸"
              TITLE="ISSUE EDITED"
              COLOR="3447003" # Blue
              ;;
            "labeled")
              EMOJI="ğŸ·ï¸"
              TITLE="LABEL ADDED"
              COLOR="10181046" # Purple
              ;;
            "unlabeled")
              EMOJI="ğŸ·ï¸âŒ"
              TITLE="LABEL REMOVED"
              COLOR="10181046"
              ;;
            "assigned")
              EMOJI="ğŸ‘¤"
              TITLE="ASSIGNEE ADDED"
              COLOR="15844367" # Gold
              ;;
            "unassigned")
              EMOJI="ğŸ‘¥"
              TITLE="ASSIGNEE REMOVED"
              COLOR="15844367"
              ;;
            *)
              EMOJI="ğŸ“‹"
              TITLE="ISSUE UPDATED"
              COLOR="3447003"
              ;;
          esac
          
          # Format labels with emojis
          LABELS="${{ join(github.event.issue.labels.*.name, ', ') }}"
          if [ -z "$LABELS" ]; then
            LABELS_DISPLAY="ğŸ·ï¸ *No labels*"
          else
            LABELS_DISPLAY="$LABELS"
          fi
          
          # Format assignees
          ASSIGNEES="${{ join(github.event.issue.assignees.*.login, ', ') }}"
          if [ -z "$ASSIGNEES" ]; then
            ASSIGNEES_DISPLAY="ğŸ‘¤ *Unassigned*"
          else
            ASSIGNEES_DISPLAY="ğŸ‘¥ $ASSIGNEES"
          fi
          
          # Check milestone
          MILESTONE="${{ github.event.issue.milestone.title }}"
          if [ -n "$MILESTONE" ]; then
            MILESTONE_DISPLAY="ğŸ¯ $MILESTONE"
          else
            MILESTONE_DISPLAY="ğŸ¯ *No milestone*"
          fi
          
          # Prepare issue body snippet (first 200 chars)
          BODY="${{ github.event.issue.body }}"
          if [ -n "$BODY" ] && [ "${#BODY}" -gt 200 ]; then
            BODY_SNIPPET="${BODY:0:197}..."
          elif [ -n "$BODY" ]; then
            BODY_SNIPPET="$BODY"
          else
            BODY_SNIPPET="*No description provided*"
          fi
          
          # Output all variables
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "labels_display=$LABELS_DISPLAY" >> $GITHUB_OUTPUT
          echo "assignees_display=$ASSIGNEES_DISPLAY" >> $GITHUB_OUTPUT
          echo "milestone_display=$MILESTONE_DISPLAY" >> $GITHUB_OUTPUT
          echo "body_snippet=$BODY_SNIPPET" >> $GITHUB_OUTPUT

      - name: ğŸš€ Send Rich Discord Embed
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;
            const repo = context.repo;
            
            // Create rich embed
            const embed = {
              title: `${{ steps.prepare.outputs.emoji }} ${{ steps.prepare.outputs.title }}`,
              description: `**[${repo.owner}/${repo.repo}]** â€¢ Issue #${issue.number}`,
              url: issue.html_url,
              color: parseInt(`${{ steps.prepare.outputs.color }}`),
              thumbnail: {
                url: issue.user.avatar_url
              },
              fields: [
                {
                  name: "ğŸ“ **Title**",
                  value: issue.title,
                  inline: false
                },
                {
                  name: "ğŸ“„ **Description**",
                  value: `${{ steps.prepare.outputs.body_snippet }}`,
                  inline: false
                },
                {
                  name: "ğŸ‘¤ **Author**",
                  value: `[${issue.user.login}](${issue.user.html_url})`,
                  inline: true
                },
                {
                  name: "ğŸ“Š **State**",
                  value: issue.state.toUpperCase(),
                  inline: true
                },
                {
                  name: "ğŸ”§ **Action**",
                  value: action.toUpperCase(),
                  inline: true
                },
                {
                  name: "${{ steps.prepare.outputs.assignees_display.split(' ')[0] }} **Assignees**",
                  value: `${{ steps.prepare.outputs.assignees_display }}`,
                  inline: true
                },
                {
                  name: "ğŸ·ï¸ **Labels**",
                  value: `${{ steps.prepare.outputs.labels_display }}`,
                  inline: true
                },
                {
                  name: "${{ steps.prepare.outputs.milestone_display.split(' ')[0] }} **Milestone**",
                  value: `${{ steps.prepare.outputs.milestone_display }}`,
                  inline: true
                },
                {
                  name: "ğŸ’¬ **Comments**",
                  value: `${issue.comments} comments`,
                  inline: true
                },
                {
                  name: "ğŸ“… **Created**",
                  value: `<t:${Math.floor(new Date(issue.created_at).getTime() / 1000)}:R>`,
                  inline: true
                },
                {
                  name: "ğŸ”„ **Updated**",
                  value: `<t:${Math.floor(new Date(issue.updated_at).getTime() / 1000)}:R>`,
                  inline: true
                }
              ],
              footer: {
                text: `GitHub Issue #${issue.number} â€¢ ${action} by ${issue.user.login}`,
                icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
              },
              timestamp: new Date().toISOString()
            };
            
            // Create Discord message
            const message = {
              content: `**${{ steps.prepare.outputs.emoji }} Issue #${issue.number} ${action}** in **${repo.owner}/${repo.repo}**\nğŸ”— [View on GitHub](${issue.html_url})`,
              embeds: [embed],
              username: "GitHub Issue Tracker",
              avatar_url: "https://cdn-icons-png.flaticon.com/512/25/25231.png"
            };
            
            // Send to Discord
            try {
              const response = await fetch(process.env.DISCORD_WEBHOOK, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(message)
              });
              
              if (!response.ok) {
                console.log(`Discord response: ${response.status} ${response.statusText}`);
              }
            } catch (error) {
              console.log(`Error sending to Discord: ${error.message}`);
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

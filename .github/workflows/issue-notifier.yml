name: GitHub Issues Discord Notifier
on:
  issues:
    types: [opened, closed, reopened, labeled, unlabeled]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare message
        id: prepare
        run: |
          # Set colors
          if [ "${{ github.event.action }}" = "opened" ]; then
            echo "color=65280" >> $GITHUB_OUTPUT
            echo "status=NEW ISSUE ðŸ“‚" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.action }}" = "closed" ]; then
            echo "color=15158332" >> $GITHUB_OUTPUT
            echo "status=ISSUE CLOSED âœ…" >> $GITHUB_OUTPUT
          else
            echo "color=3447003" >> $GITHUB_OUTPUT
            echo "status=ISSUE UPDATED ðŸ”„" >> $GITHUB_OUTPUT
          fi
          
          # Get labels
          if [ -z "${{ join(github.event.issue.labels.*.name, ', ') }}" ]; then
            echo "labels=None" >> $GITHUB_OUTPUT
          else
            echo "labels=${{ join(github.event.issue.labels.*.name, ', ') }}" >> $GITHUB_OUTPUT
          fi
          
          # Get assignees
          if [ -z "${{ join(github.event.issue.assignees.*.login, ', ') }}" ]; then
            echo "assignees=None" >> $GITHUB_OUTPUT
          else
            echo "assignees=${{ join(github.event.issue.assignees.*.login, ', ') }}" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;
            const repo = context.repo;
            
            const embed = {
              title: `#${issue.number}: ${issue.title}`,
              url: issue.html_url,
              color: ${{ steps.prepare.outputs.color }},
              fields: [
                {
                  name: 'Repository',
                  value: `${repo.owner}/${repo.repo}`,
                  inline: true
                },
                {
                  name: 'Action',
                  value: action,
                  inline: true
                },
                {
                  name: 'Author',
                  value: issue.user.login,
                  inline: true
                },
                {
                  name: 'State',
                  value: issue.state,
                  inline: true
                },
                {
                  name: 'Labels',
                  value: '${{ steps.prepare.outputs.labels }}',
                  inline: true
                },
                {
                  name: 'Assignees',
                  value: '${{ steps.prepare.outputs.assignees }}',
                  inline: true
                }
              ],
              footer: {
                text: 'GitHub Issues Bot'
              },
              timestamp: new Date().toISOString()
            };
            
            const message = {
              content: `${{ steps.prepare.outputs.status }}`,
              embeds: [embed]
            };
            
            await fetch(process.env.DISCORD_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(message)
            });
          github-token: ${{ secrets.GITHUB_TOKEN }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

name: ğŸ“‹ GitHub Issues Discord Notifier
on:
  issues:
    types: [opened, closed, reopened, edited, assigned, unassigned, labeled, unlabeled]

jobs:
  send-discord-notification:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Gather Issue Data
        id: issue-data
        run: |
          # Calculate issue age
          CREATED_AT="${{ github.event.issue.created_at }}"
          UPDATED_AT="${{ github.event.issue.updated_at }}"
          
          # Format dates (optional - using GitHub's format)
          echo "created_at=$CREATED_AT" >> $GITHUB_OUTPUT
          echo "updated_at=$UPDATED_AT" >> $GITHUB_OUTPUT
          
          # Get labels as emoji string
          LABELS_EMOJI=""
          LABELS="${{ join(github.event.issue.labels.*.name, '|') }}"
          
          if [[ "$LABELS" != "" ]]; then
            IFS='|' read -ra LABEL_ARRAY <<< "$LABELS"
            for label in "${LABEL_ARRAY[@]}"; do
              case "${label,,}" in
                *bug*) LABELS_EMOJI+="ğŸ› " ;;
                *enhancement*|*feature*) LABELS_EMOJI+="âœ¨ " ;;
                *critical*|*urgent*) LABELS_EMOJI+="ğŸš¨ " ;;
                *documentation*) LABELS_EMOJI+="ğŸ“š " ;;
                *question*) LABELS_EMOJI+="â“ " ;;
                *wip*) LABELS_EMOJI+="ğŸš§ " ;;
                *help*) LABELS_EMOJI+="ğŸ†˜ " ;;
                *security*) LABELS_EMOJI+="ğŸ”’ " ;;
                *performance*) LABELS_EMOJI+="âš¡ " ;;
                *) LABELS_EMOJI+="ğŸ·ï¸ " ;;
              esac
            done
          else
            LABELS_EMOJI="ğŸ·ï¸ No labels"
          fi
          
          echo "labels_emoji=$LABELS_EMOJI" >> $GITHUB_OUTPUT
          
          # Get assignees
          ASSIGNEES="${{ join(github.event.issue.assignees.*.login, ', ') }}"
          if [ -z "$ASSIGNEES" ]; then
            echo "assignees=ğŸ‘¤ Unassigned" >> $GITHUB_OUTPUT
          else
            echo "assignees=ğŸ‘¥ $ASSIGNEES" >> $GITHUB_OUTPUT
          fi
          
          # Set color based on action and labels
          ACTION="${{ github.event.action }}"
          if [[ "$ACTION" == "opened" ]]; then
            echo "color=65280" >> $GITHUB_OUTPUT  # Green
          elif [[ "$ACTION" == "closed" ]]; then
            echo "color=15158332" >> $GITHUB_OUTPUT  # Red
          elif [[ "$ACTION" == "reopened" ]]; then
            echo "color=16776960" >> $GITHUB_OUTPUT  # Yellow
          else
            echo "color=3447003" >> $GITHUB_OUTPUT  # Blue
          fi
          
          # Check if issue has milestone
          MILESTONE="${{ github.event.issue.milestone.title }}"
          if [ -n "$MILESTONE" ]; then
            echo "milestone=ğŸ¯ $MILESTONE" >> $GITHUB_OUTPUT
          else
            echo "milestone=ğŸ¯ No milestone" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ¨ Create Custom Embed
        id: create-embed
        run: |
          ACTION="${{ github.event.action }}"
          REPO="${{ github.repository }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          
          # Truncate long body
          if [ ${#BODY} -gt 500 ]; then
            BODY="${BODY:0:497}..."
          fi
          
          # Set action emoji
          case "$ACTION" in
            "opened") ACTION_EMOJI="ğŸ“‚" ;;
            "closed") ACTION_EMOJI="âœ…" ;;
            "reopened") ACTION_EMOJI="ğŸ”„" ;;
            "edited") ACTION_EMOJI="ğŸ“" ;;
            "assigned") ACTION_EMOJI="ğŸ‘¤" ;;
            "unassigned") ACTION_EMOJI="ğŸ‘¥" ;;
            "labeled") ACTION_EMOJI="ğŸ·ï¸" ;;
            "unlabeled") ACTION_EMOJI="ğŸ·ï¸âŒ" ;;
            *) ACTION_EMOJI="ğŸ“‹" ;;
          esac
          
          # Create embed JSON
          EMBED_JSON=$(cat << EOF
          {
            "title": "$ACTION_EMOJI Issue #$ISSUE_NUMBER: $TITLE",
            "url": "${{ github.event.issue.html_url }}",
            "color": ${{ steps.issue-data.outputs.color }},
            "fields": [
              {
                "name": "ğŸ“‚ Repository",
                "value": "$REPO",
                "inline": true
              },
              {
                "name": "ğŸ“Š Issue State",
                "value": "${{ github.event.issue.state }}",
                "inline": true
              },
              {
                "name": "ğŸ‘¤ Author",
                "value": "${{ github.event.issue.user.login }}",
                "inline": true
              },
              {
                "name": "${{ steps.issue-data.outputs.assignees }}",
                "value": "Assigned to: ${{ steps.issue-data.outputs.assignees | replace('ğŸ‘¥ ', '') | replace('ğŸ‘¤ ', '') }}",
                "inline": false
              },
              {
                "name": "ğŸ·ï¸ Labels",
                "value": "${{ steps.issue-data.outputs.labels_emoji }}\n${{ join(github.event.issue.labels.*.name, ', ') || 'No labels' }}",
                "inline": true
              },
              {
                "name": "ğŸ¯ Milestone",
                "value": "${{ steps.issue-data.outputs.milestone }}",
                "inline": true
              },
              {
                "name": "ğŸ’¬ Comments",
                "value": "${{ github.event.issue.comments }} comments",
                "inline": true
              }
            ],
            "footer": {
              "text": "GitHub Issues â€¢ Triggered by $ACTION"
            },
            "timestamp": "${{ github.event.issue.updated_at }}",
            "thumbnail": {
              "url": "https://github.com/${{ github.event.issue.user.login }}.png"
            }
          }
          EOF
          )
          
          # Escape JSON properly
          EMBED_JSON_ESCAPED=$(echo "$EMBED_JSON" | jq -R -s -c '.')
          echo "embed_json=$EMBED_JSON_ESCAPED" >> $GITHUB_OUTPUT

      - name: ğŸ“ Add Issue Body Section (if exists)
        if: github.event.issue.body != ''
        id: add-body
        run: |
          BODY="${{ github.event.issue.body }}"
          # Clean and truncate body
          CLEAN_BODY=$(echo "$BODY" | tr '\n' ' ' | sed 's/"/\\"/g')
          if [ ${#CLEAN_BODY} -gt 300 ]; then
            CLEAN_BODY="${CLEAN_BODY:0:297}..."
          fi
          
          echo "body_field={\"name\": \"ğŸ“ Description\", \"value\": \"$CLEAN_BODY\", \"inline\": false}" >> $GITHUB_OUTPUT

      - name: ğŸš€ Send to Discord
        uses: tsickert/discord-webhook@v5
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "GitHub Issue Tracker"
          avatar-url: "https://cdn-icons-png.flaticon.com/512/25/25231.png"
          embed: |
            ${{ steps.create-embed.outputs.embed_json }}
          embed-fields: |
            ${{ steps.add-body.outputs.body_field }}
          content: |
            **${{ github.event.repository.full_name }}** - Issue #${{ github.event.issue.number }}
            ğŸ”— **[View on GitHub](${{ github.event.issue.html_url }})**
            
            ğŸ“¢ **Action:** ${{ github.event.action | upper }}
            ğŸ‘¤ **By:** @${{ github.event.issue.user.login }}
            ğŸ“… **Updated:** ${{ github.event.issue.updated_at }}

      - name: ğŸ“± Send Mobile-Friendly Summary
        if: always()
        uses: appleboy/discord-action@0.0.3
        with:
          webhook_id: ${{ secrets.DISCORD_WEBHOOK_ID }}
          webhook_token: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
          username: "GitHub Mobile Alert"
          message: |
            ğŸ“± **GitHub Issue Update**
            
            ğŸ“‚ **Repo:** ${{ github.repository }}
            ğŸ« **Issue:** #${{ github.event.issue.number }}
            ğŸ“ **Title:** ${{ github.event.issue.title }}
            
            âš¡ **Action:** ${{ github.event.action }}
            ğŸ‘¤ **By:** ${{ github.event.issue.user.login }}
            
            ğŸ”— ${{ github.event.issue.html_url }}
